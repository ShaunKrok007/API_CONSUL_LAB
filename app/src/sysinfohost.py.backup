#!/usr/bin/python3 -u
# pylint: disable=missing-module-docstring
# pylint: disable=missing-class-docstring
# pylint: disable=missing-function-docstring

import platform
import psutil
import json
from flask import Flask, jsonify
import requests
from icecream import ic

import syslog
import time

def send_json_to_syslog(json_data, facility=syslog.LOG_USER, severity=syslog.LOG_INFO):
    try:
        # Format the JSON data
        formatted_json = json.dumps(json_data, indent=4)
        # Add a timestamp
        timestamp = time.strftime("%Y-%m-%d %H:%M:%S")
        log_message = f"{timestamp} {formatted_json}"
        # Send the formatted JSON to syslog
        syslog.syslog(INFO, log_message)
        syslog.closelog()
    except Exception as e:
        print(f"Error sending JSON to syslog: {e}")

app = Flask(__name__)

@app.route('/sysinfo')
def get_system_info():
    try:
        # Basic system information
        system_info = {
            "Operating System": platform.system(),
            "OS Version": platform.version(),
            "Machine Architecture": platform.machine(),
            "Processor": platform.processor(),
         }

        # CPU information
        cpu_info = {
            "CPU Cores": psutil.cpu_count(logical=False),  # Physical cores
            "Logical CPUs": psutil.cpu_count(logical=True),  # Including hyperthreads
            "CPU Usage": psutil.cpu_percent(interval=1, percpu=True),
        }

        network_stats = {
            "Disk utilization": psutil.disk_usage('/'),
        }   
        # Memory information
        memory_info = {
            "Total Memory (GB)": round(psutil.virtual_memory().total / (1024 ** 3), 2),
            "Available Memory (GB)": round(psutil.virtual_memory().available / (1024 ** 3), 2),
        }   

        # Get a list of all network interfaces
        network_interfaces = psutil.net_if_stats()
        # Prepare the data as a dictionary
        interface_data = {}
        for interface, stats in network_interfaces.items():
            interface_data[interface] = {
                'is_up': stats.isup,
                'duplex': stats.duplex,
                'mtu': stats.mtu,
                'speed': stats.speed,
        }
        merged_dict = {**system_info, **cpu_info, **memory_info, **interface_data, ** network_stats}
        json_data = json.dumps(merged_dict, indent=4)
        ic(json_data)
        response = app.response_class(
            response=json_data,
            status=200,
            mimetype='application/json'
        )
        # Add a timestamp
        send_json_to_syslog(json_data)
        return response
    except Exception as e:
        return f"Error: {str(e)}"

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5002)
